- name: Install Nginx & co.
  become: true
  become_method: sudo
  apt:
    update_cache: yes
    name:
      - nginx
      - ufw

- name: Opening webserver ports on the firewall
  become: true
  become_method: sudo
  ufw:
    rule: allow
    proto: tcp
    port: '{{ item }}'
  with_items: '{{ webserver_configuration.ports }}'

# # see: https://bugs.launchpad.net/ubuntu/+source/nginx/+bug/1581864
# # and: https://stackoverflow.com/questions/42078674/nginx-service-failed-to-read-pid-from-file-run-nginx-pid-invalid-argument#42084804
# - name: Mkdir to apply the nginx workaround
#   file:
#     dest: /etc/systemd/system/nginx.service.d
#     state: directory

# - name: Setting up the nginx workaround file
#   copy:
#     src: files/override.conf
#     dest: /etc/systemd/system/nginx.service.d/override.conf

# - name: Adding the repo for letsencrypt
#   apt_repository:
#     repo: 'ppa:certbot/certbot'
#     state: present

# - name: Installing letsencrypt stuff
#   become: true
#   become_method: sudo
#   apt:
#     update_cache: yes
#     name:
#       - software-properties-common
#       - python-certbot-nginx

- name: Restarting nginx
  service:
    daemon_reload: true
    name: nginx
    state: restarted
    enabled: true
